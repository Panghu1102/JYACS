# System Prompt 加载问题诊断与修复需求文档

## 问题描述

用户报告：当前 JYACS 项目中的新版 system prompt（位于 `python-packages/jyacs_config.json`）没有被实际应用到游戏中。AI 返回的内容和通过 API 发送的内容仍然使用旧版的简易提示词。

## 需求 1: 诊断配置文件加载失败的根本原因

**用户故事**: 作为开发者，我需要了解为什么新的配置文件没有被加载，以便找到正确的修复方案。

### 验收标准

1. **WHEN** 系统启动时 **THEN** 应该能够追踪配置文件的加载路径和状态
2. **WHEN** 配置文件加载失败时 **THEN** 应该记录详细的错误信息到日志
3. **WHEN** 配置文件加载成功时 **THEN** 应该验证 system_prompt 的内容和长度
4. **IF** 使用了默认提示词 **THEN** 应该明确记录原因（文件不存在/解析失败/路径错误）

## 需求 2: 识别所有可能的配置加载失败点

**用户故事**: 作为开发者，我需要系统性地检查所有可能导致配置加载失败的环节。

### 验收标准

1. **WHEN** 检查文件路径解析逻辑 **THEN** 应该验证 `__file__` 在 Ren'Py 环境中的行为
2. **WHEN** 检查 JSON 文件格式 **THEN** 应该验证文件是否有语法错误或编码问题
3. **WHEN** 检查初始化顺序 **THEN** 应该验证配置加载是否在正确的 init 阶段执行
4. **WHEN** 检查配置重载逻辑 **THEN** 应该验证 `reload_config()` 是否被正确调用
5. **WHEN** 检查持久化数据 **THEN** 应该验证是否有缓存的旧配置覆盖了新配置

## 需求 3: 验证配置文件的实际加载状态

**用户故事**: 作为开发者，我需要在运行时验证配置文件是否被正确加载和使用。

### 验收标准

1. **WHEN** 游戏启动时 **THEN** 应该输出配置文件的绝对路径到日志
2. **WHEN** 配置加载完成时 **THEN** 应该输出 system_prompt 的前 200 个字符到日志
3. **WHEN** 发送 API 请求时 **THEN** 应该记录实际发送的 system_prompt 内容
4. **WHEN** 用户查看配置状态时 **THEN** 应该提供完整的配置诊断信息

## 需求 4: 修复配置加载问题（场景 C：配置被覆盖）

**用户故事**: 作为开发者，我需要修复配置加载逻辑，确保新的 system prompt 能够被正确应用，即使在配置加载失败时也使用完整的默认提示词。

### 验收标准

1. **WHEN** 配置文件存在且格式正确 **THEN** 应该成功加载新的 system_prompt
2. **WHEN** 配置加载失败 **THEN** 应该使用完整版的默认 system_prompt（与配置文件中相同）
3. **WHEN** 调用 `set_api()` 方法时 **THEN** 应该触发配置重新加载
4. **WHEN** 游戏重启后 **THEN** 应该使用最新的配置文件内容
5. **WHEN** 发送聊天消息时 **THEN** API 请求应该包含正确的 system_prompt
6. **WHEN** 初始化时多次调用配置加载 **THEN** 应该避免重复加载导致的覆盖问题

## 需求 5: 提供配置验证和调试工具

**用户故事**: 作为用户，我需要能够验证当前使用的 system prompt 是否正确。

### 验收标准

1. **WHEN** 用户调用 `get_config_status()` **THEN** 应该返回完整的配置状态信息
2. **WHEN** 用户查看日志文件 **THEN** 应该能看到配置加载的详细过程
3. **WHEN** 用户手动调用 `reload_config()` **THEN** 应该强制重新加载配置文件
4. **WHEN** 配置加载失败 **THEN** 应该在游戏界面显示明确的错误提示

## 可能的问题点清单

### 1. 文件路径问题
- ❓ `__file__` 在 Ren'Py 的 `init python` 块中可能未定义或指向错误位置
- ❓ 相对路径解析可能因工作目录不同而失败
- ❓ `python-packages` 目录可能不在预期的位置

### 2. JSON 文件问题
- ❓ JSON 文件可能有语法错误（虽然看起来格式正确）
- ❓ 文件编码可能不是 UTF-8
- ❓ 文件可能被其他进程锁定

### 3. 初始化顺序问题
- ❓ 配置加载可能在 `JyacsAi` 实例创建之前执行
- ❓ `reload_config()` 可能在错误的时机被调用
- ❓ 持久化数据可能在配置加载后覆盖了设置

### 4. 代码逻辑问题
- ❓ `_load_config()` 中的异常可能被静默捕获
- ❓ 默认提示词可能在某个条件分支中被意外使用
- ❓ `set_api()` 方法可能没有正确触发配置重载

### 5. Ren'Py 特定问题
- ❓ Ren'Py 的文件系统抽象可能影响路径解析
- ❓ 打包后的游戏可能无法访问外部 JSON 文件
- ❓ 不同平台（Windows/Mac/Linux）的路径处理可能不同

### 6. 缓存问题
- ❓ Ren'Py 可能缓存了旧版本的 Python 模块
- ❓ 持久化数据可能保存了旧的配置
- ❓ 游戏可能需要完全重启才能加载新配置

## 诊断策略

### 阶段 1: 信息收集（不修改代码）
1. 检查日志文件内容
2. 验证 JSON 文件格式
3. 确认文件路径是否正确
4. 检查 Ren'Py 版本和平台信息

### 阶段 2: 增强日志（最小修改）
1. 在关键位置添加详细的日志输出
2. 记录文件路径的完整解析过程
3. 输出配置加载的每个步骤
4. 记录实际发送到 API 的内容

### 阶段 3: 修复问题（针对性修改）
1. 根据诊断结果修复路径问题
2. 改进错误处理逻辑
3. 确保配置重载机制正常工作
4. 添加配置验证功能

### 阶段 4: 验证修复（测试）
1. 测试配置文件加载
2. 验证 API 请求内容
3. 确认 AI 响应符合新提示词
4. 测试配置重载功能

## 成功标准

修复完成后，系统应该满足以下条件：

1. ✅ 游戏启动时成功加载 `jyacs_config.json` 中的 system_prompt
2. ✅ 日志文件清楚显示配置加载过程和结果
3. ✅ 发送到 API 的请求包含完整的新版 system_prompt
4. ✅ AI 的响应符合新提示词的要求（只输出台词，无动作描写）
5. ✅ 用户可以通过 `get_config_status()` 查看当前配置
6. ✅ 修改配置文件后，调用 `reload_config()` 可以立即生效
7. ✅ 系统在各种错误情况下都能提供清晰的错误信息

## 风险评估

- **高风险**: 修改核心初始化逻辑可能影响游戏稳定性
- **中风险**: 路径解析在不同平台上可能有不同行为
- **低风险**: 增加日志输出不会影响游戏功能
