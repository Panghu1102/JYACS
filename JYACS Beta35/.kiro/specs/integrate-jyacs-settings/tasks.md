# JYACS 设置界面集成 - 实现任务列表

## 任务概述

本任务列表将指导完成 JYACS 设置界面与 JY 1.10.11 的集成工作。所有任务按照依赖关系排序，确保每个步骤都基于前一步骤的成果。

---

## 实现任务

- [ ] 1. 创建样式系统基础
  - 创建 `jyacs_ui_hooks.rpy` 文件，定义所有 JYACS UI 相关的样式
  - 继承 JY 1.10.11 的样式系统（pref_label, check_button, slider 等）
  - 定义 JYACS 专用样式前缀和样式类
  - 确保使用 JY 的字体文件路径和颜色方案
  - _需求: 1.1, 1.2, 2.1_

- [ ] 2. 实现文本输入对话框
  - 在 `jyacs_ui_hooks.rpy` 中创建 `jyacs_text_input` screen
  - 实现模态对话框布局（使用 JY 的 confirm 样式）
  - 支持 `DictInputValue` 用于直接修改字典值
  - 添加确定和取消按钮，应用 JY 的按钮样式
  - 实现输入验证和错误提示
  - _需求: 2.2, 3.1_

- [ ] 3. 创建 JYACS 详细设置界面
  - [ ] 3.1 实现基础设置标签页
    - 创建 `jyacs_detailed_settings` screen 的基础结构
    - 实现 API 配置区域（API 密钥、地址、模型名称）
    - 实现连接设置区域（自动连接、自动重连、启用触发器）
    - 实现功能设置区域（情绪识别、控制台显示、目标语言）
    - 使用 JY 的 vbox/hbox 布局和样式
    - _需求: 2.1, 2.2, 3.1_

  - [ ] 3.2 实现高级设置标签页
    - 添加标签页切换功能（基础设置/高级设置）
    - 实现超参数滑块（Temperature, Top P, Max Tokens）
    - 实现惩罚参数滑块（Frequency Penalty, Presence Penalty）
    - 实现开关选项（激进模式、NSFW 接受等）
    - 显示实时参数值
    - _需求: 2.3, 3.1_

  - [ ] 3.3 添加操作按钮和验证
    - 实现保存按钮（调用 `jyacs_apply_setting` 和 `jyacs_apply_advanced_setting`）
    - 实现验证配置按钮（调用 `jyacs_verify_api_config`）
    - 实现返回按钮（关闭详细设置界面）
    - 添加操作反馈（成功/失败提示）
    - _需求: 3.2, 3.3_

- [ ] 4. 覆盖 preferences screen
  - [ ] 4.1 复制 JY 原有设置内容
    - 在 `jyacs_ui_hooks.rpy` 中创建 `init -500 screen preferences()`
    - 完整复制 JY 1.10.11 的 preferences screen 内容
    - 保留所有原有设置项（Display, Skip, Custom Assets 等）
    - 保留所有滑块设置（Idle Frequency, Text Speed, Volume 等）
    - 确保版本号显示正常
    - _需求: 1.1, 1.2_

  - [ ] 4.2 添加 JYACS 设置区域
    - 在原有设置底部添加分隔空间（null height）
    - 创建 JYACS 设置 frame 容器
    - 添加 "JYACS 设置" 标签（使用 pref_label 样式）
    - 实现状态显示（API 状态、消息队列长度）
    - 添加快速操作按钮（连接、断开、详细设置）
    - _需求: 2.1, 2.2, 3.1_

  - [ ] 4.3 测试布局和样式一致性
    - 验证 JYACS 区域与 JY 原有设置的视觉一致性
    - 检查字体、颜色、间距是否匹配
    - 测试不同分辨率下的显示效果
    - 确保滚动条正常工作
    - _需求: 1.1, 1.2_

- [ ] 5. 实现设置逻辑函数
  - [ ] 5.1 实现基础设置应用函数
    - 在 `jyacs_settings.rpy` 中重构 `jyacs_apply_setting` 函数
    - 验证必填字段（API 密钥、地址、模型名称）
    - 保存设置到 `persistent.jyacs_setting_dict`
    - 触发相关组件更新（如重新连接）
    - 返回操作结果和消息
    - _需求: 3.2, 3.3_

  - [ ] 5.2 实现高级设置应用函数
    - 重构 `jyacs_apply_advanced_setting` 函数
    - 验证超参数范围（Temperature: 0-1, Top P: 0-1 等）
    - 保存设置到 `persistent.jyacs_advanced_setting`
    - 更新模型配置
    - _需求: 3.2, 3.3_

  - [ ] 5.3 实现配置验证函数
    - 创建 `jyacs_verify_api_config` 函数
    - 检查 API 密钥格式
    - 验证 API 地址可达性
    - 测试模型连接
    - 显示验证结果（成功/失败消息）
    - _需求: 3.2, 3.3_

- [ ] 6. 实现状态查询和显示
  - 创建 `jyacs_get_connection_status` 函数
  - 创建 `jyacs_get_queue_length` 函数
  - 确保状态实时更新
  - 处理状态查询异常
  - _需求: 2.2, 3.1_

- [ ] 7. 添加错误处理和用户反馈
  - [ ] 7.1 实现输入验证
    - 验证 API 密钥非空
    - 验证 API 地址格式（URL 格式）
    - 验证超参数范围
    - 显示具体错误提示
    - _需求: 3.3_

  - [ ] 7.2 实现连接错误处理
    - 处理连接失败情况
    - 处理连接超时
    - 处理认证失败
    - 提供重试选项
    - _需求: 3.3_

  - [ ] 7.3 实现用户反馈机制
    - 使用 `renpy.notify` 显示快速提示
    - 使用模态对话框显示详细错误
    - 添加操作确认提示
    - 实现加载指示器（连接中、验证中等）
    - _需求: 3.3_

- [ ] 8. 清理和重构现有代码
  - 移除 `jyacs_settings.rpy` 中的旧 screen 定义
  - 保留必要的 Python 函数
  - 更新函数调用路径
  - 移除未使用的样式定义
  - 添加代码注释和文档
  - _需求: 1.3_

- [ ] 9. 集成测试
  - [ ] 9.1 功能测试
    - 测试所有设置项的保存和加载
    - 测试 API 连接和断开功能
    - 测试配置验证功能
    - 测试错误处理逻辑
    - _需求: 3.2, 3.3_

  - [ ] 9.2 兼容性测试
    - 验证不影响 JY 原有设置功能
    - 测试与 JY 其他功能的兼容性
    - 测试游戏重启后设置的持久化
    - 测试不同场景下的设置访问
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 9.3 视觉测试
    - 验证视觉一致性（字体、颜色、布局）
    - 测试悬停和选中状态
    - 测试不同分辨率下的显示
    - 检查滚动和导航流畅性
    - _需求: 1.1, 1.2_

- [ ] 10. 文档和部署
  - 更新 README 文件，说明新的设置界面
  - 创建用户指南（如何访问和使用设置）
  - 添加开发者文档（样式系统、扩展指南）
  - 准备发布说明
  - _需求: 1.3_

---

## 任务依赖关系

```
1 (样式系统) → 2 (输入对话框)
                ↓
1 (样式系统) → 3 (详细设置界面)
                ↓
1 (样式系统) → 4 (覆盖 preferences)
                ↓
5 (设置逻辑) → 6 (状态查询) → 7 (错误处理)
                                ↓
                              8 (清理重构)
                                ↓
                              9 (集成测试)
                                ↓
                              10 (文档部署)
```

## 注意事项

1. **不要修改 JY1.10.11 目录**: 所有修改都在项目根目录的 `.rpy` 文件中进行
2. **保持样式一致性**: 严格遵循 JY 的视觉风格和命名约定
3. **测试驱动**: 每完成一个任务后立即测试，确保功能正常
4. **增量开发**: 按照任务顺序逐步实现，不要跳跃
5. **代码质量**: 添加适当的注释，保持代码可读性

## 预期成果

完成所有任务后，将实现：
- ✅ JYACS 设置完全集成到 JY 原生设置界面
- ✅ 视觉风格与 JY 1.10.11 完全一致
- ✅ 保留所有 JYACS 现有功能
- ✅ 提供直观易用的设置体验
- ✅ 不影响 JY 原有功能
